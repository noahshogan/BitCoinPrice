<html ng-app="myApp" ng-controller="myCtrl">
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
<head>
    <link rel="shortcut icon" type="image/x-icon" href="bitcoin-icon.png" />
    <title>{{averageOfAll}}$</title>
</head>
<body>
<h1>BitCoin</h1>
<h1>BitStamp Price: {{bitSteampPrice}}$</h1>
<h1>BitFinex &nbsp Price: {{bitFinexPrice}}$</h1>
<h1>CoinDesk Price: {{coinDeskPrice}}$</h1>
<h1>minPrice : {{bitCoinMinPrice}}$ &nbsp&nbsp&nbsp  maxPrice : {{bitCoinMaxPrice}}$</h1>
<br>
<br>
<canvas id="myCanvas" width="800" height="300" style="border:1px solid #d3d3d3;"></canvas>
{{averageOfAll}}$
<br>
<br>
<h1>Ethereum</h1>
<h1>BitStamp Price: {{bitEthSteampPrice}}$</h1>
<h1>BitFinex &nbsp Price: {{bitEthFinexPrice}}$</h1>

<script>
    var app = angular.module('myApp', []);
    var bitSteampPrice;
    var bitFinexPrice;
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    var bitCoinAverage;
    var coinDeskPrice;
    var bitEthFinexPrice;
    var bitEthSteampPrice;
    var bitCoinMaxPrice=0;
    var bitCoinMinPrice=9999999999;
    var bitCoinQueue = [];
    var ethereumAverage;
    var ethereumMaxPrice=0;
    var ethereumMinPrice=9999999999;
    var ethereumQueue = [];
    app.controller('myCtrl', function($scope, $http,$rootScope) {
        function fn60sec() {
            $http.get("https://www.bitstamp.net/api/v2/transactions/btcusd/")
                .then(function(response) {
                    var total=response.data.reduce(function (acc, obj){ return acc + parseInt(obj.price);}, 0);
                    bitSteampPrice=Math.round(total/response.data.length);
                    $scope.bitSteampPrice=bitSteampPrice;
                }).then(
                $http.get("https://www.bitstamp.net/api/v2/transactions/ethusd/")
                    .then(function(response) {
                        var total=response.data.reduce(function (acc, obj){ return acc + parseInt(obj.price);}, 0);
                        bitEthSteampPrice=Math.round(total/response.data.length);
                        $scope.bitEthSteampPrice=bitEthSteampPrice;
                    })
            ).then(
                $http.get("https://api.bitfinex.com/v2/trades/tBTCUSD/hist")
                    .then(function(response) {
                        var total=response.data.reduce(function (acc, obj){ return acc + parseInt(obj[3]);}, 0);
                        bitFinexPrice=Math.round(total/response.data.length);
                        $scope.bitFinexPrice=bitFinexPrice;
                    })
            ).then(
                $http.get("https://api.bitfinex.com/v2/trades/tETHUSD/hist")
                    .then(function(response) {
                        var total=response.data.reduce(function (acc, obj){ return acc + parseInt(obj[3]);}, 0);
                        bitEthFinexPrice=Math.round(total/response.data.length);
                        $scope.bitEthFinexPrice=bitEthFinexPrice;
                    })
            ).then(
                $http.get("https://api.coindesk.com/v1/bpi/currentprice.json")
                    .then(function(response) {
                        coinDeskPrice=Math.round(response.data.bpi.USD.rate_float);
                        $scope.coinDeskPrice=coinDeskPrice;
                    })
            ).then(
                bitCoinAverage = Math.round((bitFinexPrice+bitSteampPrice+coinDeskPrice)/3)
            )
            if(!isNaN(bitCoinAverage))$rootScope.averageOfAll=bitCoinAverage;
            else if(!isNaN(bitFinexPrice))$rootScope.averageOfAll=bitFinexPrice;
            else if(!isNaN(bitSteampPrice))$rootScope.averageOfAll=bitSteampPrice;
            else if(!isNaN(coinDeskPrice))$rootScope.averageOfAll=coinDeskPrice;
            else{$rootScope.averageOfAll=(bitCoinMinPrice+bitCoinMaxPrice)/2 }
            ethereumAverage = Math.round((bitEthFinexPrice+bitEthSteampPrice)/2)

            addToMinMax(bitCoinAverage,ethereumAverage)
        }
        fn60sec();
        setInterval(fn60sec, 10000);


        function addToMinMax(bitCoinAverageRef,ethereumAverageRef){
            bitCoinQueue.push(bitCoinAverageRef);
            ethereumQueue.push(ethereumAverageRef);
            if(bitCoinQueue.length>360){
                bitCoinQueue.shift();
                ethereumQueue.shift();
            }
            bitCoinMinPrice=999999;
            bitCoinMaxPrice=0;
            ethereumMinPrice=999999;
            ethereumMaxPrice=0;
            for(var i = 0 ; i < bitCoinQueue.length ; i++){
                if(bitCoinQueue[i]<bitCoinMinPrice) bitCoinMinPrice=bitCoinQueue[i];
                if(bitCoinQueue[i]>bitCoinMaxPrice) bitCoinMaxPrice=bitCoinQueue[i];
                if(ethereumQueue[i]<ethereumMinPrice) ethereumMinPrice=ethereumQueue[i];
                if(ethereumQueue[i]>ethereumMaxPrice) ethereumMaxPrice=ethereumQueue[i];
            }
            $scope.bitCoinMinPrice=bitCoinMinPrice;
            $scope.bitCoinMaxPrice=bitCoinMaxPrice;
            draw();
        }
        function draw(){
            ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
            ctx.beginPath();
            ctx.strokeStyle="green";
            var firstBitHight = (270/(bitCoinMaxPrice-bitCoinMinPrice))*(bitCoinQueue[0]-bitCoinMinPrice);
            ctx.moveTo(0, 300-firstBitHight);
            if(bitCoinQueue.length>1){
                for(var i = 1 ; i < bitCoinQueue.length ; i++){
                    var bitHight = (270/(bitCoinMaxPrice-bitCoinMinPrice))*(bitCoinQueue[i]-bitCoinMinPrice);
                    ctx.lineTo(2.2*(i), 300-bitHight);
                }
            }
            ctx.stroke();

            ctx.beginPath();
            ctx.strokeStyle="blue";
            var firstEthHight = (270/(ethereumMaxPrice-ethereumMinPrice))*(ethereumQueue[0]-ethereumMinPrice);
            ctx.moveTo(0, 300-firstEthHight);
            if(ethereumQueue.length>1){
                for(var j = 1 ; j < ethereumQueue.length ; j++){
                    var ethHight = (270/(ethereumMaxPrice-ethereumMinPrice))*(ethereumQueue[j]-ethereumMinPrice);
                    ctx.lineTo(2.2*(j), 300-ethHight);
                }
            }
            ctx.stroke();

        }
    });


</script>
</body>
</html>
